{"version":3,"file":"AuthController.js","sourceRoot":"","sources":["../../src/controllers/AuthController.ts"],"names":[],"mappings":"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","sourcesContent":["import {Controller, Inject, Post, Req, $log, Get, PathParams, Patch} from \"@tsed/common\";\r\nimport {UserService} from \"../services/UserService\";\r\nimport {Authenticate, Authorize} from \"@tsed/passport\";\r\nimport {User} from \"../models/User\";\r\nimport {PostService} from \"../services/PostService\";\r\nimport {Post as Posts} from \"../models/Post\";\r\nimport {log} from \"console\";\r\n// export const tempId = \"5f549bc077ff7458309f1b5c\";\r\n@Controller(\"\")\r\nexport class UserController {\r\n  constructor(@Inject(UserService) public userService: UserService, @Inject(PostService) private service: PostService) {}\r\n\r\n  @Post(\"/login\")\r\n  @Authenticate(\"login\")\r\n  async login(@Req(\"user\") req: User) {\r\n    return req;\r\n  }\r\n\r\n  @Post(\"/signup\")\r\n  @Authenticate(\"signup\")\r\n  signUp(@Req(\"user\") req: User) {\r\n    try {\r\n      // $log.info(req);\r\n      return req;\r\n    } catch (error) {\r\n      $log.error(error);\r\n    }\r\n  }\r\n  @Get(\"/session\")\r\n  @Authorize(\"jwt\")\r\n  async getSession(@Req(\"account\") req: User) {\r\n    try {\r\n      // const user = req.user || {id: null};\r\n      // $log.info(req.session);\r\n      // return user;\r\n      // const user = await this.userService.findById(tempId);\r\n      // $log.info(\"session\", req);\r\n      req.password = \"\";\r\n      return req;\r\n    } catch (error) {\r\n      $log.error(error);\r\n      return null;\r\n    }\r\n  }\r\n  @Get(\"/user/:id\")\r\n  async getUser(@PathParams(\"id\") id: String) {\r\n    try {\r\n      const user = await this.userService.findById(id);\r\n\r\n      return user;\r\n    } catch (error) {\r\n      $log.error(error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  @Patch(\"/bookmark/:id\")\r\n  @Authorize(\"jwt\")\r\n  async toggleBookMark(@PathParams(\"id\") id: string, @Req(\"account\") req: User) {\r\n    let updatedPost: string[];\r\n\r\n    const foundPost = await this.service.findById(id);\r\n\r\n    if (!foundPost) {\r\n      return null;\r\n    }\r\n    const result = req.bookMarkedPosts?.find((postId) => postId.toString() === id.toString());\r\n\r\n    if (result) {\r\n      updatedPost = req.bookMarkedPosts?.filter((postId) => postId.toString() !== id.toString()) || [];\r\n      req.bookMarkedPosts = updatedPost;\r\n\r\n      foundPost.bookMarks = (foundPost.bookMarks as number) - 1;\r\n    } else {\r\n      updatedPost = req.bookMarkedPosts?.concat(id.toString()) || [id.toString()];\r\n      req.bookMarkedPosts = updatedPost;\r\n      foundPost.bookMarks = (foundPost.bookMarks as number) + 1;\r\n    }\r\n    $log.info(foundPost);\r\n    await this.userService.set(req);\r\n    await this.service.set(foundPost);\r\n    return foundPost;\r\n  }\r\n\r\n  @Patch(\"/like/:id\")\r\n  @Authorize(\"jwt\")\r\n  async toggleLike(@PathParams(\"id\") id: string, @Req(\"account\") req: User) {\r\n    let updatedPost: string[];\r\n\r\n    const foundPost = await this.service.findById(id);\r\n    if (!foundPost) {\r\n      return;\r\n    }\r\n    const result = req.likedPosts?.find((postId) => postId.toString() === id.toString());\r\n\r\n    if (result) {\r\n      updatedPost = req.likedPosts?.filter((postId) => postId.toString() !== id.toString()) || [];\r\n      req.likedPosts = updatedPost;\r\n\r\n      foundPost.likes = (foundPost.likes as number) - 1;\r\n    } else {\r\n      updatedPost = req.likedPosts?.concat(id.toString()) || [id.toString()];\r\n      req.likedPosts = updatedPost;\r\n      foundPost.likes = (foundPost.likes as number) + 1;\r\n    }\r\n\r\n    await this.userService.set(req);\r\n    await this.service.set(foundPost);\r\n    return foundPost;\r\n  }\r\n  @Get(\"/logout\")\r\n  logout(@Req() req: Req) {\r\n    try {\r\n      req.logout();\r\n      req.user = undefined;\r\n      $log.info(\"logged out\", req.session);\r\n    } catch (error) {\r\n      $log.error(error);\r\n    }\r\n  }\r\n}\r\n"]}